import{f as b,r as o,u as j,j as r}from"./index-C05QhGEP.js";import{S as _}from"./Send-DdTSUrsa.js";import{S as h}from"./sweetalert2.all-I3mqL4O0.js";import{p as y,a as v}from"./apiServices-BLiMT9Yd.js";import{l as E}from"./index-CGwCSIWv.js";import{b as D}from"./index-CBktOoLW.js";import{A as M}from"./api-CigzIjai.js";import"./index-By0aXpWG.js";import"./iconBase-DrVbEGxc.js";import"./axios-B4uVmeYG.js";import"./Socket-BAmX9CkN.js";const H=()=>{const{id:i}=b(),[l,f]=o.useState([]),[u,m]=o.useState(""),g=localStorage.getItem("token"),a=o.useRef(null),s=o.useRef(null),x=j(),{apiKey:w}=M;o.useEffect(()=>(s.current||(s.current=E(w),s.current.on("receive_message",e=>{e&&e.message&&f(t=>{const d={...e.message,...e.data};return t.some(c=>c.id===d.id)?t:[...t,d].sort((c,S)=>new Date(c.created_at)-new Date(S.created_at))})}),s.current.on("connect_error",e=>{console.error("WebSocket connection error:",e)})),m(""),()=>{s.current&&(s.current.disconnect(),s.current=null)}),[l,i]),o.useEffect(()=>{a.current&&(a.current.scrollTop=a.current.scrollHeight)},[l,a]);const p=async()=>{if(u.trim()!==""){const e={message:u};try{await y("send-message-to-agent",e,g,i),s.current&&s.current.emit("send_message",e),m("")}catch(t){console.error("Error submitting data:",t),h.fire({icon:"error",title:"Error",text:"Something went wrong. Please try again."})}}};return o.useEffect(()=>{a.current&&(a.current.scrollTop=a.current.scrollHeight)},[l]),o.useEffect(()=>{(async()=>{try{const t=await v("get-all-messages",g,"786",i);if(t&&t.adminMessages&&t.agentMessages){const d=[...t.adminMessages.map(n=>({...n,created_at:n.created_at||new Date().toISOString()})),...t.agentMessages.map(n=>({...n,created_at:n.created_at||new Date().toISOString()}))].sort((n,c)=>new Date(n.created_at)-new Date(c.created_at));f(d)}else console.error("Unexpected data format:",t)}catch(t){console.error("Error fetching messages:",t),h.fire({icon:"error",title:"Error",text:"Failed to load messages. Please try again."})}})()},[i,g]),r.jsxs("div",{className:"chat-container",children:[r.jsx("div",{className:"chat-header",children:r.jsx(D,{onClick:()=>x("/"),style:{cursor:"pointer"}})}),r.jsx("div",{className:"chat-window",ref:a,children:l.map((e,t)=>r.jsxs("div",{className:`chat-bubble ${e.role==="admin"?"bot-bubble":"user-bubble"}`,children:[r.jsx("div",{children:e.message}),r.jsx("div",{style:{fontSize:"10px",textAlign:"right",color:"#c5c5ca",paddingTop:"3px"},children:new Date(e.created_at).toLocaleTimeString()})]},t))}),r.jsxs("div",{className:"input-container",children:[r.jsx("input",{className:"chat-input",type:"text",placeholder:"Type a message.",value:u,onChange:e=>m(e.target.value),onKeyPress:e=>e.key==="Enter"&&p()}),r.jsx("div",{onClick:p,children:r.jsx(_,{})})]})]})};export{H as default};
