import{f as j,r as n,u as _,j as a}from"./index-C05QhGEP.js";import{S as v}from"./Send-DdTSUrsa.js";import{S as x}from"./sweetalert2.all-I3mqL4O0.js";import{a as y,h as D}from"./apiServices-BLiMT9Yd.js";import{a as E}from"./agentInfo-CITVD4br.js";import{l as M}from"./index-CGwCSIWv.js";import{b as k}from"./index-CBktOoLW.js";import{A as N}from"./api-CigzIjai.js";import"./index-By0aXpWG.js";import"./iconBase-DrVbEGxc.js";import"./axios-B4uVmeYG.js";import"./Socket-BAmX9CkN.js";import"./middleware-COLfL0G6.js";const G=()=>{const{id:u}=j(),[d,f]=n.useState([]),[l,p]=n.useState(""),m=localStorage.getItem("token"),{userData:g}=E(),r=n.useRef(null),c=n.useRef(null),S=localStorage.getItem("agentId"),w=_(),{apiKey:I}=N;n.useEffect(()=>(r.current||(r.current=M(I),r.current.on("receive_message",e=>{e&&e.message&&e.data.message&&e.data.agentId==S&&f(t=>{const i={...e.message,...e.data};return t.some(o=>o.id===i.id)?t:[...t,i].sort((o,b)=>new Date(o.created_at)-new Date(b.created_at))})}),r.current.on("connect_error",e=>{console.error("WebSocket connection error:",e)})),()=>{r.current&&(r.current.disconnect(),r.current=null)}),[d,r]),n.useEffect(()=>{(async()=>{try{const t=await y("get-all-messages",m,"786",u||g.agentId);if(t&&t.adminMessages&&t.agentMessages){const i=[...t.adminMessages.map(s=>({...s,created_at:s.created_at||new Date().toISOString()})),...t.agentMessages.map(s=>({...s,created_at:s.created_at||new Date().toISOString()}))].sort((s,o)=>new Date(s.created_at)-new Date(o.created_at));f(i)}else console.error("Unexpected data format:",t)}catch(t){console.error("Error fetching messages:",t),x.fire({icon:"error",title:"Error",text:"Failed to load messages. Please try again."})}})()},[u,m,g.agentId]),n.useEffect(()=>{c.current&&(c.current.scrollTop=c.current.scrollHeight)},[d]);const h=async()=>{if(l.trim()!==""){const e={message:l};try{await D("send-message-to-admin",e,m,g.agentId),r.current&&r.current.emit("send_message",e),p("")}catch(t){console.error("Error submitting data:",t),x.fire({icon:"error",title:"Error",text:"Something went wrong. Please try again."})}}};return a.jsxs("div",{className:"chat-container",children:[a.jsx("div",{className:"chat-header",children:a.jsx(k,{onClick:()=>w("/agent/agentLeads"),style:{cursor:"pointer"}})}),a.jsx("div",{className:"chat-window",ref:c,children:d.map((e,t)=>a.jsxs("div",{className:`chat-bubble ${e.role==="agent"?"bot-bubble":"user-bubble"}`,children:[a.jsx("div",{children:e.message}),a.jsx("div",{style:{fontSize:"10px",textAlign:"right",color:"#c5c5ca"},children:new Date(e.created_at).toLocaleTimeString()})]},t))}),a.jsxs("div",{className:"input-container",children:[a.jsx("input",{type:"text",className:"chat-input",placeholder:"Type a message.",value:l,onChange:e=>p(e.target.value),onKeyPress:e=>e.key==="Enter"&&h()}),a.jsx("div",{onClick:h,children:a.jsx(v,{})})]})]})};export{G as default};
